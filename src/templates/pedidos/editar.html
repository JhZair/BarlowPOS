{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-warning text-dark d-flex justify-content-between">
            <h4 class="mb-0">✏️ Editar Pedido #{{ pedido.id_pedido }}</h4>
            <span>Total actual: S/ {{ pedido.total }}</span>
        </div>
        <div class="card-body">
            <form action="{{ url_for('pedidos.editar_pedido', id=pedido.id_pedido) }}" method="POST">
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Mesa</label>
                        <select name="id_mesa" class="form-select border-warning">
                            {% for m in mesas %}
                                <option value="{{ m.id_mesa }}" {% if m.id_mesa == pedido.id_mesa %} selected {% endif %}>
                                    Mesa {{ m.numero }} ({{ m.estado }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted">Mesero (No editable)</label>
                        <input type="text" class="form-control" value="{{ pedido.nombre_mesero }}" disabled>
                    </div>
                </div>

                <hr>

                <h5 class="mb-3">Productos del Pedido</h5>
                <div id="productos-container">
                    
                    {% for d in detalles %}
                    <div class="row mb-2 producto-row align-items-end">
                        <div class="col-md-7">
                            <select name="productos[]" class="form-select">
                                {% for p in productos %}
                                    <option value="{{ p.id_producto }}" 
                                        {% if p.id_producto == d.id_producto %} selected {% endif %}>
                                        {{ p.nombre }} - S/ {{ p.precio_base }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" name="cantidades[]" class="form-control" value="{{ d.cantidad }}" min="1" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger w-100" onclick="eliminarFila(this)">X</button>
                        </div>
                    </div>
                    {% endfor %}

                </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="agregarProducto()">
                        + Agregar otro plato
                    </button>
                </div>

                <hr class="mt-4">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-warning btn-lg">Guardar Todos los Cambios</button>
                    <a href="{{ url_for('pedidos.index') }}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="template-row" style="display:none;">
    <div class="row mb-2 producto-row align-items-end">
        <div class="col-md-7">
            <select name="productos[]" class="form-select" required>
                <option value="" disabled selected>Seleccione producto...</option>
                {% for p in productos %}
                <option value="{{ p.id_producto }}">{{ p.nombre }} - S/ {{ p.precio_base }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" name="cantidades[]" class="form-control" value="1" min="1" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger w-100" onclick="eliminarFila(this)">X</button>
        </div>
    </div>
</div>

<script>
    function agregarProducto() {
        const container = document.getElementById('productos-container');
        const template = document.getElementById('template-row').firstElementChild;
        const clone = template.cloneNode(true);
        container.appendChild(clone);
    }

    function eliminarFila(btn) {
        btn.closest('.producto-row').remove();
    }
</script>
{% endblock %}